{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="tool-container">
    <div class="hero-section">
        <h1>‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ PDF (Unlock PDF)</h1>
        <p>‡∏õ‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞ PIN</p>
    </div>

    <!-- MAIN FORM WRAPPER -->
    <!-- Important: Form must allow file upload (multipart) -->
    <form id="unlock-form" method="post" enctype="multipart/form-data" action="{% url 'converter:unlock_pdf' %}">
        {% csrf_token %}

        <div class="card-wrapper">

            <!-- Upload Zone -->
            <label for="real-file-input" class="upload-zone" id="drop-zone">
                <!-- File Input (Hidden but Functional) -->
                <input type="file" name="file" id="real-file-input" accept=".pdf" required
                    onchange="handleFileSelect(this)">

                <div class="upload-graphics">
                    <div class="folder-icon">üìÇ</div>
                    <h3 id="status-text">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h3>
                    <p id="sub-status">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
                </div>
            </label>

            <!-- Options Panel (Hidden until file selected) -->
            <div id="hidden-options" class="options-area">
                <div class="separator"><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ</span></div>

                <div class="radio-group">
                    <!-- Mode: Unknown (Default) -->
                    <label class="radio-card active" id="card-unknown" onclick="setMode('unknown')">
                        <input type="radio" name="mode" value="unknown" checked>
                        <div class="card-icon">üïµÔ∏è</div>
                        <div class="card-info">
                            <b>‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</b>
                            <small>‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤‡πÉ‡∏´‡πâ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</small>
                        </div>
                    </label>

                    <!-- Mode: Known -->
                    <label class="radio-card" id="card-known" onclick="setMode('known')">
                        <input type="radio" name="mode" value="known">
                        <div class="card-icon">üîë</div>
                        <div class="card-info">
                            <b>‡∏£‡∏π‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</b>
                            <small>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</small>
                        </div>
                    </label>
                </div>

                <!-- Input for known password -->
                <div id="passport-input-box" style="display:none;">
                    <input type="text" name="password" id="password-input" class="magic-input"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1234, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)">
                </div>

                <button type="submit" class="start-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ üîì</button>
            </div>
        </div>

        <!-- Error Alert -->
        {% if error %}
        <div class="alert-box error" style="margin-top: 20px;">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-content">
                <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                <p>{{ error }}</p>
            </div>
        </div>
        {% endif %}

    </form>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-box">
        <div class="spinner"></div>
        <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</h2>
        <div class="terminal-text" id="terminal-log">> Uploading file...</div>
    </div>
</div>

<style>
    /* Clean Layout */
    .tool-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 0 20px;
        box-sizing: border-box;
    }

    .card-wrapper {
        background: var(--bg-card, #fff);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .card-wrapper {
        background: #1e1e1e;
        border-color: #333;
    }

    /* Upload Zone */
    .upload-zone {
        display: block;
        border: 3px dashed #ddd;
        border-radius: 12px;
        padding: 40px 10px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: 0.2s;
        position: relative;
    }

    .upload-zone:hover {
        border-color: #e5322d;
        background: rgba(229, 50, 45, 0.02);
    }

    [data-theme="dark"] .upload-zone {
        background: #252525;
        border-color: #444;
    }

    .upload-zone.has-file {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
        border-style: solid;
    }

    #real-file-input {
        display: none;
    }

    /* Hide raw input */

    .folder-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    .upload-zone h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-main);
        word-break: break-all;
        padding: 0 10px;
        line-height: 1.4;
    }

    .upload-zone p {
        margin: 5px 0 0;
        color: #888;
        font-size: 0.9rem;
    }

    /* Options */
    .options-area {
        margin-top: 20px;
        display: none;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .separator {
        display: flex;
        align-items: center;
        margin: 20px 0;
        color: #999;
        font-size: 0.85rem;
        text-transform: uppercase;
    }

    .separator::before,
    .separator::after {
        content: "";
        flex: 1;
        height: 1px;
        background: #eee;
        margin: 0 10px;
    }

    .radio-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .radio-card {
        border: 2px solid #eee;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.2s;
        position: relative;
    }

    [data-theme="dark"] .radio-card {
        border-color: #444;
    }

    .radio-card input {
        position: absolute;
        opacity: 0;
    }

    /* Hide radio hardware */
    .radio-card.active {
        border-color: #e5322d;
        background: rgba(229, 50, 45, 0.05);
    }

    .card-icon {
        font-size: 1.5rem;
    }

    .card-info {
        text-align: left;
        display: flex;
        flex-direction: column;
    }

    .card-info b {
        font-size: 0.9rem;
        color: var(--text-main);
    }

    .card-info small {
        font-size: 0.75rem;
        color: #888;
    }

    .magic-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-top: 15px;
        text-align: center;
        box-sizing: border-box;
        font-size: 1rem;
    }

    .magic-input:focus {
        border-color: #e5322d;
        outline: none;
    }

    .start-btn {
        width: 100%;
        padding: 15px;
        background: #e5322d;
        color: white;
        border: none;
        border-radius: 8px;
        margin-top: 20px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.1rem;
        transition: 0.2s;
    }

    .start-btn:hover {
        background: #d0201b;
        transform: translateY(-2px);
    }

    /* Alert */
    .alert-box {
        display: flex;
        gap: 15px;
        padding: 15px;
        border-radius: 10px;
        background: #fff5f5;
        border: 1px solid #fed7d7;
        color: #c53030;
        text-align: left;
    }

    .alert-icon {
        font-size: 1.5rem;
    }

    /* Loading */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .loading-box {
        text-align: center;
        color: white;
        padding: 20px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid #e5322d;
        border-radius: 50%;
        animation: spin 1s infinite linear;
        margin: 0 auto 20px;
    }

    .terminal-text {
        font-family: monospace;
        color: #0f0;
        margin-top: 10px;
        font-size: 0.9rem;
        opacity: 0.8;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Mobile Responsive Fixes */
    @media (max-width: 480px) {
        .tool-container {
            margin: 20px auto;
            padding: 0 15px;
        }

        .hero-section h1 {
            font-size: 1.8rem;
        }

        .hero-section p {
            font-size: 0.95rem;
        }

        .card-wrapper {
            padding: 20px 15px;
        }

        .upload-zone {
            padding: 30px 10px;
        }

        .folder-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .radio-group {
            grid-template-columns: 1fr;
        }

        .card-info {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .card-info small {
            margin-left: 10px;
        }
    }
</style>

<script>
    // 1. File Selection Logic
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const f = input.files[0];

            // Visual Feedback
            document.getElementById('status-text').textContent = f.name;
            document.getElementById('status-text').style.color = '#28a745';
            document.getElementById('sub-status').textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
            document.getElementById('drop-zone').classList.add('has-file');

            // Show Config
            const options = document.getElementById('hidden-options');
            options.style.display = 'block';
            setTimeout(() => options.style.opacity = '1', 50);
        }
    }

    // 2. Drag & Drop Logic (Links directly to input)
    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#e5322d'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#ddd'; });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ddd';

        if (e.dataTransfer.files.length) {
            document.getElementById('real-file-input').files = e.dataTransfer.files;
            handleFileSelect(document.getElementById('real-file-input'));
        }
    });

    // 3. Mode Selection Logic
    window.setMode = function (mode) {
        // UI toggle
        document.getElementById('card-unknown').classList.remove('active');
        document.getElementById('card-known').classList.remove('active');
        document.getElementById(`card-${mode}`).classList.add('active');

        // Input toggle
        const box = document.getElementById('passport-input-box');
        const input = document.getElementById('password-input');

        if (mode === 'known') {
            box.style.display = 'block';
            document.querySelector('input[value="known"]').checked = true;
            setTimeout(() => input.focus(), 100);
        } else {
            box.style.display = 'none';
            document.querySelector('input[value="unknown"]').checked = true;
        }
    };

    // 4. Submit Animation
    document.getElementById('unlock-form').addEventListener('submit', function () {
        document.getElementById('loading-overlay').style.display = 'flex';
        const term = document.getElementById('terminal-log');
        const mode = document.querySelector('input[name="mode"]:checked').value;

        if (mode === 'unknown') {
            let i = 0;
            setInterval(() => {
                term.textContent = `> BruteForce: Checking pattern #${i++ * 333}...`;
            }, 50);
        } else {
            term.textContent = "> Decrypting with known key...";
        }
    });
</script>
{% endblock %}