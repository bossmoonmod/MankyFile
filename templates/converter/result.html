{% extends 'base.html' %}

{% block content %}
<div class="tool-container">
    <div class="tool-header">
        <h1>ประมวลผลไฟล์สำเร็จ!</h1>
        <p>ไฟล์ {{ file_type|default:"WORD" }} ของคุณถูกสร้างเรียบร้อยแล้ว</p>
    </div>

    <div class="upload-area">
        <div style="margin-bottom: 25px;">
            <label for="filename-input"
                style="display:block; margin-bottom: 8px; color:#555; font-weight: 500;">ตั้งชื่อไฟล์ที่ต้องการบันทึก:</label>
            <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                <input type="text" id="filename-input" value="merged_document"
                    style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 280px; text-align: center; font-size: 16px; outline: none; transition: border-color 0.2s;">
                <span id="file-extension" style="font-size: 16px; color: #666; font-weight: 500;"></span>
            </div>
        </div>

        <a href="#" id="download-btn" class="btn-upload-big">
            <span style="font-size: 20px;">ดาวน์โหลด {{ file_type|default:"WORD" }}</span>
        </a>

        <script>
            const filenameInput = document.getElementById('filename-input');
            const downloadBtn = document.getElementById('download-btn');
            const fileExtSpan = document.getElementById('file-extension');
            const fileId = "{{ file_id }}";
            const fileType = "{{ file_type|default:'WORD' }}";

            // Set file extension based on type
            const extension = fileType === 'PDF' ? '.pdf' : '.docx';
            fileExtSpan.textContent = extension;

            // Focus input on load for convenience
            filenameInput.focus();
            filenameInput.select();

            // Function to update download link
            function updateDownloadLink() {
                let name = filenameInput.value.trim();
                name = name.replace(/[<>:"/\\|?*]/g, ''); // Clean invalid chars

                if (!name) name = 'merged_document';

                // Construct URL for the download endpoint
                const url = `{% url 'converter:download_file' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', fileId) + `?filename=${encodeURIComponent(name)}`;

                downloadBtn.href = url;
            }

            // Update input style on focus
            filenameInput.addEventListener('focus', () => {
                filenameInput.style.borderColor = '#e5322d';
            });

            filenameInput.addEventListener('blur', () => {
                filenameInput.style.borderColor = '#ddd';
            });

            filenameInput.addEventListener('input', updateDownloadLink);

            // Initialize link
            updateDownloadLink();

            // Allow enter key to trigger download
            filenameInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    downloadBtn.click();
                }
            });
        </script>

        <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <a href="{% url 'converter:index' %}"
                style="color: #666; text-decoration: none; border: 1px solid #ccc; padding: 10px 20px; border-radius: 6px;">กลับหน้าหลัก</a>
            <a href="#"
                style="color: #666; text-decoration: none; border: 1px solid #ccc; padding: 10px 20px; border-radius: 6px;">ลบไฟล์ทันที</a>
        </div>
    </div>
</div>
{% endblock %}