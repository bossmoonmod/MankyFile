{% extends 'base.html' %}

{% block content %}
<div class="tool-container">
    <div class="tool-header">
        <h1 id="tool-title-heading">{{ title }}</h1>
        <p id="tool-subtitle-text">{{ subtitle }}</p>
    </div>

    <!-- Error Message Display -->
    {% if error %}
    <div
        style="background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ef9a9a; text-align: center;">
        <strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Upload Form -->
    <div class="upload-area">
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'converter:host_image' %}">
            {% csrf_token %}

            <!-- Hidden input for file selection -->
            <input type="file" id="image-input" name="image" style="display: none;" accept="image/*">

            <a href="#" id="select-image-btn" class="btn-upload-big">
                <span data-i18n="btn_select_file">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
            </a>

            <div class="drop-text" data-i18n="drag_drop_hint">‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>

            <!-- Client-side Preview -->
            <div id="preview-container" style="display: none; margin-top: 20px; text-align: center;">
                <p style="font-weight: 600; color: #555; margin-bottom: 10px;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î:</p>
                <img id="image-preview" src="" alt="Preview"
                    style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <p style="margin-top: 10px; font-size: 0.9em; color: #d32f2f; cursor: pointer; font-weight: 600;"
                    onclick="window.clearImageSelection()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</p>
            </div>

            <div class="settings-panel"
                style="margin-top: 30px; text-align: left; background: rgba(0,0,0,0.03); padding: 20px; border-radius: 12px; border: 1px dashed rgba(0,0,0,0.1);">
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">
                    <i class="fas fa-trash-alt"></i> Auto delete
                </label>
                <select name="auto_delete" class="lang-select"
                    style="width: 100%; height: 45px; border-radius: 8px; padding: 0 15px;">
                    <option value="never">Don't auto delete</option>
                    <option value="5min">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
                    <option value="15min">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 15 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
                    <option value="30min">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
                    <option value="1h">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="3h">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="6h">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="12h">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="1d">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏ß‡∏±‡∏ô</option>
                    <option value="2d">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏±‡∏ô</option>
                    <option value="3d">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="1w">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                    <option value="2w">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                    <option value="1m">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="2m">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="3m">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                </select>
            </div>

            <button type="submit" id="submit-btn" class="btn btn-primary"
                style="display: none; margin-top: 25px; width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 30px;">
                ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢! üöÄ
            </button>
        </form>
    </div>

    <!-- Progress / Status -->
    <div id="progress-container"
        style="display: none; margin-top: 30px; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto;">
        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
            <div id="progress-bar"
                style="background: var(--primary-color); width: 0%; height: 100%; transition: width 0.3s;"></div>
        </div>
        <p id="status-text" style="margin-top: 15px; color: #666; font-weight: 500;">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á...</p>
    </div>
</div>

<script>
    const imageInput = document.getElementById('image-input');
    const selectBtn = document.getElementById('select-image-btn');
    const submitBtn = document.getElementById('submit-btn');
    const form = document.getElementById('upload-form');
    const progressContainer = document.getElementById('progress-container');
    const uploadArea = document.querySelector('.upload-area');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('image-preview');

    function handleFileSelection(file) {
        if (!file.type.startsWith('image/')) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
            submitBtn.style.display = 'block';
            selectBtn.querySelector('span').textContent = file.name;
            submitBtn.scrollIntoView({ behavior: 'smooth' });
        };
        reader.readAsDataURL(file);
    }

    window.clearImageSelection = function () {
        imageInput.value = '';
        previewContainer.style.display = 'none';
        submitBtn.style.display = 'none';
        selectBtn.querySelector('span').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
    }

    selectBtn.addEventListener('click', (e) => {
        e.preventDefault();
        imageInput.click();
    });

    imageInput.addEventListener('change', () => {
        if (imageInput.files.length > 0) {
            handleFileSelection(imageInput.files[0]);
        }
    });

    form.addEventListener('submit', () => {
        uploadArea.style.display = 'none';
        progressContainer.style.display = 'block';

        let p = 0;
        const interval = setInterval(() => {
            p += Math.random() * 15;
            if (p > 95) { p = 95; clearInterval(interval); }
            document.getElementById('progress-bar').style.width = p + '%';
        }, 200);
    });

    const dropZone = document.querySelector('.tool-container');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = 'rgba(229, 50, 45, 0.05)'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.background = 'transparent'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = 'transparent';
        if (e.dataTransfer.files.length > 0) {
            imageInput.files = e.dataTransfer.files;
            handleFileSelection(imageInput.files[0]);
        }
    });

    // Handle Paste (Ctrl+V)
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                imageInput.files = createFileList(blob);
                handleFileSelection(blob);
                break;
            }
        }
    });

    function createFileList(file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        return dt.files;
    }
</script>

<style>
    .settings-panel i {
        margin-right: 8px;
        color: var(--primary-color);
    }

    [data-theme='dark'] .settings-panel {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock %}